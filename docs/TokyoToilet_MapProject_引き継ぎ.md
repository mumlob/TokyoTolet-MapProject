TokyoToilet_MapProject_引き継ぎ.md

# 東京トイレット・ルート地図作成プロジェクト 引き継ぎメモ

## 1. プロジェクトの目的
渋谷区内の THE TOKYO TOILET（17地点）について、
以下を満たす完全な地図画像を作成すること。

- 背景：国土地理院タイルの広域地図（縮小・変形なし）
- 赤点：全17地点＋恵比寿駅（開始）＋笹塚駅（終了）
- 青線：徒歩での巡回ルート（最短巡回順序にもとづく）
- 最終出力：PNG （背景と正しい投影の座標変換込み）

最終的には "背景地図の上で、きちんと位置が一致したルート図" を得る。

## 2. 現在までに完了している作業

### 2.1 17地点の正確なWGS84座標リスト
ユーザー提供の CSV（UTF-8 BOMなし、LF、No/名称/lat./lon.）をもとに、
すべての地点の緯度・経度を取得済み。

地点構成：
- No=1〜17：東京トイレット公衆トイレ（公式 Location Map の順）
- No=S：JR恵比寿駅（開始地点）
- No=G：京王線笹塚駅（終了地点）

※ 列名は「lat.」「lon.」。

### 2.2 巡回順序（最短ルート）
大円距離（Haversine）にもとづく TSP（2-opt 近似）により算出済み。

巡回順：
S → 15 → 14 → 13 → 16 → 17 → 12 → 11 → 10 →
9 → 5 → 7 → 8 → 6 → 4 → 3 → 2 → 1 → G

総直線距離：約 13.4km

### 2.3 背景なしの線画プロット
matplotlib にて、緯度経度のまま線図（散布＋折れ線）を生成済み。

※ 現状の線図は「地図投影補正（メルカトル等）なし」のため、
　南北方向が実地図より縦長に見える。

## 3. 今後の主要タスク（重要）

### 3.1 地図投影の選択
背景地図と完全に一致させるには、投影方式が必須。
候補は：

- Webメルカトル投影（Google Maps / GSI標準）
- 経度方向 cos(lat) による簡易補正（非推奨：精度が落ちる）

**結論：Webメルカトル投影で統一する。**
（背景タイルと合わせるため）

### 3.2 緯度経度 → Webメルカトル座標変換
以下の式で x,y を計算する：

x = R * lon_rad
y = R * ln( tan(pi/4 + lat_rad/2) )

R = 地球半径（6378137m）

### 3.3 背景地図（国土地理院タイル）の扱い
- 以前のセッションで「縮小される」「右にずれる」などの問題発生
- 原因：大画像の自動縮小・Python セッションの2048px制限・投影不一致
- 新セッションでは **最初から投影とサイズを明確に定義して合成** する

背景画像は次の方針で扱う：

1. ユーザーがアップロードする「元PNG」は ChatGPT が縮小するため使用不可  
2. ChatGPT 側で「必要部分のみの GSI タイルを再ダウンロード」して背景を再構築する  
3. Webメルカトル座標で正しく投影された状態で合成

### 3.4 背景地図との合成
- 背景タイルから「画像座標 → Webメルカトル → 緯度経度 → プロット座標」の対応付けを行う
- 赤点（トイレ・開始駅・終了駅）を正しい位置に描く
- 青線（巡回ルート）をメルカトル座標に変換して描画

### 3.5 最終出力（PNG）
- 2048px 制限内に収まるよう最適化（縦横比維持）
- ダウンロード可能な PNG を生成する

## 4. 次セッションで私（ChatGPT）が最初に必要とする情報

1. **ユーザーのCSV（TokyoToilets-list.csv）を再アップロード**  
　（これをもとに全座標をメルカトル変換する）

2. **背景地図範囲の指定**  
　（例：渋谷区全域、緯度経度の bounding box、など）

3. **最終PNGの希望サイズ**  
　例：  
　- 1600×1600  
　- 1920×1080  
　- 2048×2048（最大）  

4. 線や点のスタイル指定  
　（赤点・青線・番号位置など）

## 5. 注意事項（今回の混乱を避けるため）

- 背景画像のアップロードは避ける（自動縮小され狂うため）
- 投影方式はセッション開始時に必ず固定する（Webメルカトル）
- 座標はすべて CSV から読み込む（Excel は避ける）
- Python プロットが破綻しないよう画像サイズ上限を守る（2048px以内）
- 大規模作業は短セッションで行う（コンテキスト混乱防止）
